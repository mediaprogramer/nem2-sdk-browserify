<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
<title>050_aggregate_complete</title>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://unpkg.com/rxjs/bundles/rxjs.umd.min.js"></script>
<script src="https://s3-ap-northeast-1.amazonaws.com/xembook.net/nem2-sdk/nem2-sdk-0.13.0.js"></script>
<script>
$(function() {

/*
{"meta":{"height":[530298,0],"hash":"C3BBA41B284BF291B4FC73AA914BC5E619F7C9B7C3F56F362F877276BD00A245","merkleComponentHash":"C3BBA41B284BF291B4FC73AA914BC5E619F7C9B7C3F56F362F877276BD00A245","index":0,"id":"5D00697B28174C00014569CF"},"transaction":{"signature":"3573D273AAAF49ED5965B4B1D68A5468C6A8C17F51A566C7F81F05B9BB82D46DD4AED152F5DC9BD7872283766638E2028E07064586C3F9C80303BF915ACE8104","signer":"AC1A6E1D8DE5B17D2C6B1293F1CAD3829EEACF38D09311BB3C8E5A880092DE26","version":36866,"type":16718,"maxFee":[0,0],"deadline":[2062190168,23],"namespaceType":0,"duration":[1000,0],"namespaceId":[646738821,2754876907],"name":"xembook"}}
*/

//XEMBook Test Account MIJIN_TEST (http://nfwallet.z31.web.core.windows.net/)
//	  [PRIVATE_KEY]：289D5C9F9CF2FA65DB8FAE30F0E1A4AAEFCFA62A1E17ABAA095C6796AE4170C6
//	  [PUBLICK_KEY]：FF6E61F2A0440FB09CA7A530C0C64A275ADA3A13F60D1EC916D7F1543D7F0574
//	  [ADDRESS]：SCAZJP2UPDEMZJZMY3CCUJQGXY7JMDVJ7CRG6ROT

	const GENERATION_HASH = "3125DF8F8C726660526886BAD6531A51A520845D984BE47943F9F844885CC7CA";
//	const PRIKEY = "CD52E4CA8F6EC1ADBE4BEF392BAD666179A495F87CBC15176F30C8A82EBA90D6";
//	const RECIPIENT = "SCA7ZS2B7DEEBGU3THSILYHCRUR32YYE55ZBLYA2";

//	const aliceAddress = 'CD52E4CA8F6EC1ADBE4BEF392BAD666179A495F87CBC15176F30C8A82EBA90D6';
//	const bobAddress = 'SCGPXB-2A7T4I-W5MQCX-FQY4UQ-W5JNU5-F55HGK-HBUN';

	const nem = require("/home/ec2-user/node_modules/nem2-sdk");

	const aliceAccount = nem.Account.createFromPrivateKey('CD52E4CA8F6EC1ADBE4BEF392BAD666179A495F87CBC15176F30C8A82EBA90D6',nem.NetworkType.MIJIN_TEST);
	const bobAccount = nem.Account.createFromPrivateKey('289D5C9F9CF2FA65DB8FAE30F0E1A4AAEFCFA62A1E17ABAA095C6796AE4170C6',nem.NetworkType.MIJIN_TEST);

console.log(bobAccount);


	const NODE = "http://18.182.13.103:3000";//
	const transactionHttp = new nem.TransactionHttp(NODE);

//	const privateKey = "CD52E4CA8F6EC1ADBE4BEF392BAD666179A495F87CBC15176F30C8A82EBA90D6";
//	const account = nem.Account.createFromPrivateKey(privateKey, nem.NetworkType.MIJIN_TEST);

//	const aliceAccount = nem.Address.createFromRawAddress(aliceAddress);
//	const bobAccount = nem.Address.createFromRawAddress(bobAddress);

	const sendAmount = nem.NetworkCurrencyMosaic.createRelative(1000);
	const backAmount = nem.NetworkCurrencyMosaic.createRelative(1);

	const aliceTransferTransaction = nem.TransferTransaction.create(nem.Deadline.create(), aliceAccount.address, [sendAmount], nem.PlainMessage.create('payout'), nem.NetworkType.MIJIN_TEST);
	const bobTransferTransaction   = nem.TransferTransaction.create(nem.Deadline.create(), bobAccount.address, [backAmount], nem.PlainMessage.create('payout'), nem.NetworkType.MIJIN_TEST);


	const aggregateTransaction = nem.AggregateTransaction.createComplete(
		nem.Deadline.create(),
		[
			aliceTransferTransaction.toAggregate(aliceAccount.publicAccount),
			bobTransferTransaction.toAggregate(bobAccount.publicAccount)
		],
		nem.NetworkType.MIJIN_TEST,
		[]
	).serialize();

	const signedTxBob   = nem.CosignatureTransaction.signTransactionPayload(bobAccount, aggregateTransaction, GENERATION_HASH);

	const cosignatureSignedTransactions = [
	    new nem.CosignatureSignedTransaction(signedTxBob.parentHash, signedTxBob.signature, signedTxBob.signer)
	];

	const recreatedTx = nem.TransactionMapping.createFromPayload(aggregateTransaction);
	const signedTransaction = recreatedTx.signTransactionGivenSignatures(aliceAccount, cosignatureSignedTransactions, GENERATION_HASH);
	console.log(signedTransaction);

$('button').click(function(){

    transactionHttp
        .announce(signedTransaction)
        .subscribe(x =>{ 
            console.log(x);
            $('#items2-ctrl ul').append('<li><a target="_blank" href="' + NODE + '/transaction/' + signedTransaction.hash + '/status">' + signedTransaction.hash + '</a></li>');
            $('#items3-ctrl ul').append('<li><a target="_blank" href="' + NODE + '/transaction/' + signedTransaction.hash + '">' + signedTransaction.hash + '</a></li>');
        }, 
        err => console.error(err)
        );
});
});

</script>
</head>
<body>

	<h1>050_transfer</h1>
	<div id="items-ctrl">
		<ul>
			<li>[FROM]：<span id="signer_address"></span></li>
			<li>[TO]：<span id="recipient_address"></span></li>
		</ul>
	</div>
	<div id="btn-ctrl"><button>送信</button></div>
	<h3>state確認</h1><div id="items2-ctrl"><ul></ul></div>
	<h3>confirmed確認</h1><div id="items3-ctrl"><ul></ul></div>
</body>
</html>
